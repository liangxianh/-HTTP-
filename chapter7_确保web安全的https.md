### 确保web安全的https

在http协议中有可能存在信息窃听或身份伪装等安全问题，使用https通信机制可以有效的防止这些问题；

#### 一 http的缺点

* 通信使用明文（不加密），内容可能被窃听；
* 不验证通信方的身份，因此有可能遭遇伪装；
* 无法证明报文的完整性，所以有可能已遭篡改；

这些问题不仅在http上出现，其他未加密的协议中也会存在这类问题；

1. 通信使用明文可能会被窃听
由于http本身不具备加密功能，无法做到对通信整体（http协议通信的请求和响应）进行加密，即http报文使用明文发送；像wireshark这种抓包工具可以获取http协议的请求和响应的内容，并对其进行解析；我们可以加密处理防止被窃听

* 通信的加密：http协议没有加密机制，可以通过和ssl(secure socket layer,安全套接层)和tls(transport layer security,安全传输协议)的组合使用，加密http的通信内容；

 > 用ssl建立安全通信后，就可以在这条线路上进行http通信了；与ssl组合的http被称为**https**（http secure,超文本传输安全协议）或**http over ssl**

* 内容的加密：对http报文的内容进行加密处理，前提要求客户端和服务器同时具备加密和解密机制；主要应用于web服务中，由于不是对整个通信链路进行加密，所以内容仍然有被篡改的风险；

2. 不验证通信方的身份，因此有可能遭遇伪装

http协议中的请求和响应不会对通信方进行确认；即存在服务端是否就是发送请求uri真正指定的主机，返回的响应是否真正的返回到实际提出请求的客户端等问题

* 任何人都可发起请求（web服务器没有设置限定访问的前提下）
> 无法确认请求发送到目标的web服务器是否是按真实意图返回响应的那台服务器；有可能是已伪装的web服务器；

> 无法确定返回到的客户端是否是按真实意图接收响应的那个客户端；有可能是已伪装的客户端；

> 无法确定正在通信的双方是否具备访问权限，因为某些web服务器上保存着重要的信息，只想发给特定用户通信的权限；

> 无法判定请求是来自何方出自谁手；
 
> 即使是无意义的请求也会照单全收；无法阻止海量请求下的dos攻击（denial of service，拒绝服务攻击）


* 查明对手的证书

虽然使用http无法确定通信方，但是使用ssl则可以；ssl不仅提供通道加密处理，而且还使用了一种被称为证书的手段，可以用于确认通信方；证书是有信任的第三方机构颁发，用于证明客户端和服务器是实际存在的；

3. 无法证明报文的完整性，所以有可能已遭篡改

* 接受到的内容可能有误
请求或响应在传输途中被攻击者拦截并篡改内容的攻击称为中间人攻击（Man-in-the-Middle attack,MITM）

* 如何防止篡改
常用的是MD5和SHA-1等散列值校验的方法，以及用来确认文件的数字签名方法，但是MD5本身被篡改的话，用户没有办法得知；防止这些弊端，可以使用https；ssl提供认证和加密处理及摘要功能；

#### 二 http+加密+认证+完整性保护 = https

1. http+ 通信加密+ 证书 +完整性保护，我们把添加了加密及认证机制的http称为https
2. https是身披ssl外壳的http；通常http直接和tcp通信，当使用ssl时，则演变为先和ssl通信，在由ssl和tcp通信；

* ssl是独立于http的协议，所以不光是http协议，其他运行在应用层的smtp和telnet等协议都可以配合ssl协议使用；ssl是世界上应用最广泛的网络安全技术；

3. 相互交换密钥的公开密钥加密技术
ssl采用一种公开密钥加密的加密处理方式；而现代的加密方法中加密算法一般是公开的，而密钥是保密的，通过这种方式得以保持加密方法的安全性；

* 共享加密的困境

加密和解密用同一个密钥的方式称为共享密钥加密（common key crypto system），也叫对称密钥加密；这种方式必须将密钥也发送给对方，如何安全的转交呢？（发送密钥就会有被窃听的风险，但是不发送对方就不能解密，在者，密钥若能安全发送，数据也应该能安全的送达）

* 使用两把密钥的公开密钥加密

公开密钥加密解决了共享密钥加密的困难，公开加密使用一对非对称的密钥，一把叫私有密钥，一把叫公开密钥；发送密文的一方使用公开密钥加密，接收方使用自己的私有密钥进行解密；这种方式不需要发送用来加密的私有密钥，也就不用担心密钥被攻击者窃听；

* https使用混合加密机制；

https使用共享加密和公开加密两种方式混合；对比共享加密公开加密处理速度更慢；

> 使用公开密钥加密方式安全地交换在稍后的共享密钥加密中要使用的密钥(即公开密钥)；（非对称加密 后面的密钥）
> 确保交换的密钥是安全的前提下，使用共享密钥加密方式（利用上面传递过来的公开密钥对数据加密）进行通信；（对数据进行对称加密）

4. 证明公开密钥正确性的证书
存在一个问题就是，公开密钥加密方式，无法证明公开密钥本身就是货真价实的公开密钥；为此可以使用由数字证书认证机构（CA certificate authority）和其他相关机关颁发的公开密钥证书；数字证书认证机构处于客户端和服务器双方都可信赖的第三方机构的立场上

> 服务器把自己的公开密钥登录至数字证书认证机构；

> 数字证书认证机构的公开密钥已事先植入到浏览器里了；

> 数字证书认证机构用自己的私有密钥向服务器的公开密码部署数字签名并颁发公钥证书；

> 客户端拿到服务器的公钥证书后，使用数字证书机构的公开密钥，向数字证书认证机构校验公钥证书上的数字签名，以确认服务器的公开密钥的真实性；

> 使用服务器的公开密钥对报文加密后发送；

> 服务器用私有密钥对报文解密；

* 可证明组织真实性的EV SSL证书
证书的作用，一是用来证明作为通信一方的服务器是否规范；二是可确认对方服务器背后运营的企业是否真实存在；拥有该特性的证书就是EV SSL证书（extended validation ssl certificate）

* 用以确认客户端的客户端证书
https还可以使用客户端证书，进行客户端认证，证明服务器正在通信的对方始终是预料之内的客户端；存在一下两处问题：
一是证书获取需要用户自行安装，让知识层面不同的用户自行安装会存在各种挑战；
二是客户端正式是要付费购买的，且每张证书对应每个用户，意味着需要支付和用户数对等的费用；
所以现状是。仅仅用于特殊用途，如网上银行；

* 认证机构信誉第一
* 自由认证机构颁发的证书称为自签名证书
一般是独立构建的认证机构颁发的‘无用’证书被戏称为自签名证书，浏览器访问该服务时，会显示‘无法确认连接安全性’或者‘该网站的安全证书存在问题’等警告信息；

5. https的安全通信机制
+ 步骤一：客户端通过发送Client hello报文开始SSL通信。报文中包含客户端支持的SSL的指定版本，加密组件（Cipher suite）列表（所使用的加密算法及密钥长度等）
+ 步骤二：服务器可进行SSL通信时，会以Server Hello报文作为应答；和客户端一样在报文中包含SSL版本以及加密组件；服务端的加密组件内容是从接收到的客户端加密组建内筛选出来的；
+ 步骤三：服务器发送Certificate报文；报文中包含公开密钥证书；
+ 步骤四：服务器发送Server Hello Done报文通知客户端，最初阶段的SSl握手协商部分结束；
+ 步骤五：ssl第一次握手结束后，客户端以Client Key Exchange报文作为回应；报文中包含通信加密中使用的一种被称为Pre-master secret的随机密码串；该报文已使用了步骤三中的公开密钥进行加密；
+ 步骤六：接着客户端继续发送Change Cipher Spec报文；该报文提示服务器，在此报文之后的通信会采用Pre-master secret密钥加密；
+ 步骤七：客户端发送Finished报文；该报文包含连接至今全部报文的整体校验值；这次握手协商能否成功，要以服务器是否能够正确解密该报文作为判断；
+ 步骤八：服务器同样的发送Change Cipher Spec报文；
+ 步骤九：服务器同样的发送Finished报文；
+ 步骤十：服务器和客户端的Finished报文交换完毕之后，SSL连接就算建立完成；通信会收到ssl保护；从此处开始进行应用层的协议的通信，即发送http请求；
+ 步骤十一：应用层协议通信，发送http响应；
+ 步骤十二：最后由客户端断开连接；断开连接时发送close_notify报文；
+ 步骤十三：发送TCP FIN报文来关闭与TCP的通信；

以上步骤中：应用层发送数据时，会附加一种叫MAC（Message Authentication Code）的报文摘要，MAC能够查知报文是否遭到篡改从而保护报文的完整性；
```
客户端                                   服务器
    1 -----> handshake:ClientHello ---->
      <------ Handshake:ServerHello <---- 2
      <------ Handshake:Certificate <---- 3
      <------ Handshake:ServerHelloDone <---- 4
    5 -----> handshake:ClientKeyExchange -->
    6 -----> ChangeCipherSpec ---->
    7 -----> handshake:Finished ---->
      <------ ChangeCipherSpec   <---- 8
      <------ handshake:Finished  <---- 9
   10 -----> Application Data(HTTP) ---->
      <------ Application Data(HTTP) <---- 11
   12 -----> Alert: warning,close notify ---->
   
```
* SSL和TSL
https使用ssl和tsl这两个协议，当前主流版本时ssl3.0和tsl1.0

* SSL速度慢
https也存在一些问题，就是当使用ssl时，处理速度会变慢；一是通信慢，一是大量消耗cpu资源和内存等资源，导致处理速度变慢；因为https要处理服务器，客户端双方加密及解密处理，会消耗cpu和内存等硬件资源；和使用http相比，网络负载可能会变慢**2到100倍**；针对速度变慢，没有根本的解决方案，可以使用ssl加速器（专用服务器）硬件来改善；

* 为何不一直使用https
因为与纯文本通信相比，加密通信会消耗更多的cpu及内存资源，而且购买证书也是需要一定的开销；非敏感信息一般使用http通信，敏感信息使用https通信



> 注意：**http默认使用80端口，https默认使用443端口**



